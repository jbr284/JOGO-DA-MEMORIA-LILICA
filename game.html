<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Mem√≥ria (Online)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png" type="image/png">
    <meta name="theme-color" content="#16213e">
    
    <style>
        :root {
            --bg-color: #1a1a2e; --card-color: #16213e; --card-flipped-color: #0f3460;
            --text-color: #e94560; --accent-color: #ffffff; --player1-color: #53a8b6; --player2-color: #e94560;
            --card-size: 60px; 
            --board-gap: 8px; 
        }
        body {
            font-family: 'Arial', sans-serif; background-color: var(--bg-color); color: var(--accent-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box;
        }
        h1 { color: var(--text-color); margin-bottom: 10px; font-size: 1.8em; }
        .game-info { 
            display: flex; justify-content: space-between; 
            width: calc(6 * var(--card-size) + 5 * var(--board-gap)); 
            max-width: 95%; 
            margin-bottom: 15px; font-size: 1.0em; /* Reduzido para caber Vit√≥rias */
        }
        .player-score { 
            padding: 8px 15px; border-radius: 8px; font-weight: bold; transition: all 0.3s ease; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 48%; /* Ajustado */
            text-align: center; /* Centraliza texto */
        } 
        /* NOVO: Estilo para vit√≥rias */
        .victories { font-size: 0.8em; opacity: 0.8; display: block; margin-top: 2px;}

        #player1-info { background-color: var(--player1-color); }
        #player2-info { background-color: var(--player2-color); }
        .player-score.active { box-shadow: 0 0 10px var(--accent-color); transform: scale(1.05); }
        #turn-info { width: 100%; text-align: center; font-size: 1.3em; margin-bottom: 15px; font-weight: bold; min-height: 1.5em; }
        
        .game-board { 
            display: grid;
            grid-template-columns: repeat(6, var(--card-size)); 
            grid-template-rows: repeat(6, var(--card-size));    
            gap: var(--board-gap); 
            perspective: 1000px; 
        }
        .card {
            width: var(--card-size); height: var(--card-size); 
            position: relative; transform-style: preserve-3d;
            transition: transform 0.6s; cursor: pointer;
        }
        .card.flipped, .card.matched { transform: rotateY(180deg); cursor: default; }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 6px; display: flex; align-items: center; justify-content: center; 
            font-size: calc(var(--card-size) * 0.6); 
        }
        .card-front { background-color: var(--card-flipped-color); transform: rotateY(180deg); }
        .card-back { background-color: var(--card-color); border: 2px solid var(--text-color); }

        /* NOVO: Anima√ß√£o de par encontrado */
        @keyframes matchAnimation {
            0%, 100% { transform: scale(1) rotateY(180deg); box-shadow: none; } /* Mant√©m virada */
            50% { transform: scale(1.15) rotateY(180deg); box-shadow: 0 0 15px yellow; } /* Aumenta e brilha */
        }
        .card.play-match-animation {
            animation: matchAnimation 0.7s ease-in-out;
        }
        
        /* NOVO: Bot√£o Jogar Novamente */
        #play-again-btn {
             margin-top: 15px; padding: 10px 20px; font-size: 1em; font-weight: bold;
             color: var(--accent-color); background-color: var(--player1-color); /* Cor diferente */
             border: none; border-radius: 8px; cursor: pointer; display: none; /* Come√ßa escondido */
        }

        #reset-button { /* Bot√£o Voltar ao Lobby */
            margin-top: 10px; /* Reduzido */ padding: 10px 20px; font-size: 1em; font-weight: bold;
            color: var(--accent-color); background-color: var(--text-color); border: none; border-radius: 8px; cursor: pointer;
        }
        #game-id-display { font-size: 0.8em; color: var(--accent-color); margin-top: 10px; opacity: 0.7; }
    </style>
</head>
<body>

    <h1>Jogo da Mem√≥ria Online</h1>
    
    <div class="game-info">
        <div id="player1-info" class="player-score">Jogador 1: 0</div> 
        <div id="player2-info" class="player-score">Jogador 2: 0</div>
    </div>
    
    <div id="turn-info">Conectando...</div>
    
    <div class="game-board" id="game-board">
        </div>

    <button id="play-again-btn">Jogar Novamente</button> 
    <button id="reset-button">Voltar ao Lobby</button>
    <div id="game-id-display"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Config Firebase
        const firebaseConfig = { /* ... (sua config aqui) ... */ };
        let database; 
        try { firebase.initializeApp(firebaseConfig); database = firebase.database(); console.log("Firebase inicializado."); } 
        catch (e) { console.error("ERRO FIREBASE:", e); alert("Erro Firebase."); throw new Error("Falha Firebase"); }

        document.addEventListener('DOMContentLoaded', () => {
            // Emojis 6x6
            const emojis = [ 'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶' ];
            
            // Seletores DOM
            const gameBoard = document.getElementById('game-board');
            const player1InfoEl = document.getElementById('player1-info'); 
            const player2InfoEl = document.getElementById('player2-info');
            const turnInfoEl = document.getElementById('turn-info');
            const resetButton = document.getElementById('reset-button'); // Voltar Lobby
            const playAgainBtn = document.getElementById('play-again-btn'); // NOVO
            const gameIdDisplay = document.getElementById('game-id-display');

            // Vari√°veis de estado
            let gameStateRef; 
            let gameId;       
            let playerId;     
            let lockBoard = false;
            let myPlayerUUID;
            let playerNames = { 1: "P1", 2: "P2" }; // Nomes padr√£o curtos
            let currentBoardState = {}; // Guarda o estado local para anima√ß√£o

            // --- FUN√á√ÉO DE INICIALIZA√á√ÉO ---
            function initGame() { /* ... (igual √† vers√£o anterior) ... */ }

            // --- Fun√ß√£o: "Ouvir" as mudan√ßas do Jogo no Firebase ---
            function setupGameListeners() {
                gameIdDisplay.textContent = `ID da Sala: ${gameId}`;
                if (gameStateRef) gameStateRef.off(); 

                gameStateRef.on('value', (snapshot) => {
                    const state = snapshot.val();
                    if (!state) { /* ... (tratamento de jogo encerrado) ... */ return; } 

                    // Atualiza nomes
                    playerNames[1] = state.player1_name || "P1";
                    playerNames[2] = state.player2_name || "P2";

                    // Normaliza estado
                    state.flippedCards = state.flippedCards || [];
                    state.scores = state.scores || { 1: 0, 2: 0 };
                    state.victories = state.victories || { 1: 0, 2: 0 }; // NOVO: Garante vit√≥rias
                    state.board = state.board || {};
                    
                    // Compara estado antigo com novo para anima√ß√£o (NOVO)
                    const oldBoardState = currentBoardState;
                    currentBoardState = state.board; // Atualiza estado local

                    updateScoreboard(state.scores, state.victories, state.currentPlayer); // Passa vit√≥rias
                    updateTurnInfo(state.currentPlayer, state.winner, state.player2); 
                    renderBoard(currentBoardState, oldBoardState, state.winner); // Passa estado antigo e winner
                    
                    // L√≥gica de checar par (ajustada)
                    // S√≥ checa se for o jogador da vez E se o estado mudou E se tem 2 cartas viradas
                    if (state.flippedCards.length === 2 && playerId === state.currentPlayer && !lockBoard) { 
                        lockBoard = true; 
                        // Delay ligeiramente maior para garantir que a segunda carta virou visualmente
                        setTimeout(() => checkForMatch(state), 900); 
                    } else if (state.flippedCards.length < 2) {
                        lockBoard = false; // Garante que destrava se o outro jogador fez par
                    }
                }, (error) => { /* ... (tratamento de erro do listener) ... */ });
            }

            // --- Fun√ß√£o: Renderizar o Tabuleiro (ATUALIZADA para anima√ß√£o) ---
            function renderBoard(newBoardState, oldBoardState, winner) {
                 gameBoard.innerHTML = '';
                 const sortedKeys = Object.keys(newBoardState).sort((a, b) => parseInt(a) - parseInt(b));
                 
                 sortedKeys.forEach(key => {
                     const cardData = newBoardState[key];
                     const oldCardData = oldBoardState ? oldBoardState[key] : null; // Pega dado antigo
                     const cardEl = createCardElement(cardData);
                     
                     // L√≥gica da Anima√ß√£o (NOVO)
                     // Se a carta AGORA est√° 'matched', mas ANTES n√£o estava, toca a anima√ß√£o
                     if (cardData.isMatched && (!oldCardData || !oldCardData.isMatched)) {
                          // Adiciona a classe e remove depois de um tempo
                          cardEl.classList.add('play-match-animation');
                          setTimeout(() => cardEl.classList.remove('play-match-animation'), 700); // Dura√ß√£o da anima√ß√£o
                     }
                     
                     gameBoard.appendChild(cardEl);
                 });
                 // Mostra/Esconde bot√£o Jogar Novamente (NOVO)
                 playAgainBtn.style.display = winner !== null ? 'block' : 'none';
            }
            
            // --- Fun√ß√£o: Criar o Elemento HTML da Carta ---
            function createCardElement(cardData) { /* ... (igual √† vers√£o anterior) ... */ }

            // --- Fun√ß√£o: L√≥gica do Clique (ENVIA A JOGADA) ---
            function onCardClick(cardData) { /* ... (igual √† vers√£o anterior) ... */ }

            // --- Fun√ß√£o: Verificar se √© um Par (ATUALIZADA para Vit√≥rias) ---
            function checkForMatch(state) {
                 // A transa√ß√£o agora √© mais complexa, atualiza vit√≥rias se houver vencedor
                 gameStateRef.transaction(currentState => {
                    if (!currentState) return currentState; 
                    if (!currentState.flippedCards || currentState.flippedCards.length !== 2) return currentState; 

                    const [id1, id2] = currentState.flippedCards;
                    if (!currentState.board[id1] || !currentState.board[id2]) return currentState; 

                    const card1 = currentState.board[id1];
                    const card2 = currentState.board[id2];
                    const isMatch = card1.emoji === card2.emoji;

                    if (isMatch) {
                        currentState.scores[currentState.currentPlayer]++;
                        currentState.matchedPairs++;
                        currentState.board[id1].isMatched = true;
                        currentState.board[id2].isMatched = true;
                    } else {
                        currentState.currentPlayer = currentState.currentPlayer === 1 ? 2 : 1;
                        currentState.board[id1].isFlipped = false;
                        currentState.board[id2].isFlipped = false;
                    }
                    
                    currentState.flippedCards = []; 

                    // Verifica fim de jogo e atualiza vit√≥rias (NOVO)
                    if (currentState.matchedPairs === emojis.length) { 
                         const p1Score = currentState.scores[1];
                         const p2Score = currentState.scores[2];
                         currentState.winner = p1Score > p2Score ? 1 : (p2Score > p1Score ? 2 : 0);
                         // Incrementa vit√≥ria se n√£o for empate
                         if (currentState.winner !== 0) {
                              currentState.victories = currentState.victories || { 1: 0, 2: 0 }; // Garante que existe
                              currentState.victories[currentState.winner]++;
                         }
                    }
                    return currentState;
                 });
            }
            
            // --- Fun√ß√£o: Atualizar Placar (Atualizada para Vit√≥rias) ---
            function updateScoreboard(scores, victories, currentPlayer) {
                // Formato: Nome (V: X) Y pts
                player1InfoEl.textContent = `${playerNames[1]} (V:${victories[1]}) ${scores[1]} pts`; 
                player2InfoEl.textContent = `${playerNames[2]} (V:${victories[2]}) ${scores[2]} pts`; 
                
                player1InfoEl.classList.toggle('active', currentPlayer === 1);
                player2InfoEl.classList.toggle('active', currentPlayer === 2);
            }
            
            // --- Fun√ß√£o: Atualizar Info de Turno e Fim de Jogo ---
            function updateTurnInfo(currentPlayer, winner, player2_connected) { /* ... (igual √† vers√£o anterior) ... */ }

            // --- Fun√ß√£o: Resetar Tabuleiro para Jogar Novamente (NOVO) ---
            function resetBoardForNewRound() {
                 console.log("Resetando tabuleiro para nova rodada...");
                 gameStateRef.transaction(currentState => {
                      if (!currentState) return null; // Jogo n√£o existe mais

                      // S√≥ reseta se o jogo realmente acabou
                      if (currentState.winner === null) return currentState; 

                      // Embaralha novas cartas
                      const cardPairs = [...emojis, ...emojis].sort(() => 0.5 - Math.random());
                      currentState.board = {};
                      cardPairs.forEach((emoji, index) => {
                          currentState.board[index] = { id: index, emoji: emoji, isFlipped: false, isMatched: false };
                      });
                      
                      // Reseta estado da rodada
                      currentState.scores = { 1: 0, 2: 0 };
                      currentState.flippedCards = []; 
                      currentState.matchedPairs = 0;
                      currentState.winner = null;
                      currentState.winnerInfo = null; // Limpa info da linha vencedora
                      // Decide quem come√ßa a pr√≥xima rodada (ex: alterna ou perdedor come√ßa)
                      // Vamos alternar: Se P1 ganhou ou empatou, P2 come√ßa. Se P2 ganhou, P1 come√ßa.
                      currentState.currentPlayer = (currentState.winner === 1 || currentState.winner === 0) ? 2 : 1; 

                      // Mant√©m: gameId, gameType, UUIDs, Nomes, Vit√≥rias
                      
                      return currentState;
                 });
            }

            // --- Event Listeners ---
            resetButton.addEventListener('click', () => { /* ... (igual) ... */ });
            
            // NOVO Listener para Jogar Novamente
            playAgainBtn.addEventListener('click', () => {
                 // Idealmente, apenas um jogador (ex: P1) deveria poder iniciar o reset
                 // Mas para simplificar, qualquer um pode clicar por enquanto.
                 resetBoardForNewRound();
            });

            // --- Inicia o Jogo ---
            initGame();
        });
    </script>
</body>
</html>
