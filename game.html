<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Mem√≥ria (Online)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png" type="image/png">
    <meta name="theme-color" content="#16213e">

    <style>
        :root {
            --bg-color: #1a1a2e; --card-color: #16213e; --card-flipped-color: #0f3460;
            --text-color: #e94560; --accent-color: #ffffff; --player1-color: #53a8b6; --player2-color: #e94560;
            --card-size: 60px;
            --board-gap: 8px;
        }
        body {
            font-family: 'Arial', sans-serif; background-color: var(--bg-color); color: var(--accent-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box;
        }
        h1 { color: var(--text-color); margin-bottom: 10px; font-size: 1.8em; }
        .game-info {
            display: flex; justify-content: space-between;
            width: calc(6 * var(--card-size) + 5 * var(--board-gap));
            max-width: 95%;
            margin-bottom: 15px; font-size: 1.0em;
        }
        .player-score {
            padding: 8px 15px; border-radius: 8px; font-weight: bold; transition: all 0.3s ease;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 48%;
            text-align: center;
        }
        .victories { font-size: 0.8em; opacity: 0.8; display: block; margin-top: 2px;}

        #player1-info { background-color: var(--player1-color); }
        #player2-info { background-color: var(--player2-color); }
        .player-score.active { box-shadow: 0 0 10px var(--accent-color); transform: scale(1.05); }
        #turn-info { width: 100%; text-align: center; font-size: 1.3em; margin-bottom: 15px; font-weight: bold; min-height: 1.5em; }

        .game-board {
            display: grid;
            grid-template-columns: repeat(6, var(--card-size));
            grid-template-rows: repeat(6, var(--card-size));
            gap: var(--board-gap);
            perspective: 1000px;
        }
        .card {
            width: var(--card-size); height: var(--card-size);
            position: relative; transform-style: preserve-3d;
            transition: transform 0.6s; cursor: pointer;
        }
        .card.flipped, .card.matched { transform: rotateY(180deg); cursor: default; }

        /* Regra .card-face COM a corre√ß√£o anti-arraste */
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            font-size: calc(var(--card-size) * 0.6);
            /* Impedir sele√ß√£o de texto */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE/Edge */
            user-select: none; /* Padr√£o */
            /* Impedir arrastar */
            -webkit-user-drag: none;
            user-drag: none;
        }

        .card-front { background-color: var(--card-flipped-color); transform: rotateY(180deg); }
        .card-back { background-color: var(--card-color); border: 2px solid var(--text-color); }

        @keyframes matchAnimation { 0%, 100% { transform: scale(1) rotateY(180deg); box-shadow: none; } 50% { transform: scale(1.15) rotateY(180deg); box-shadow: 0 0 15px yellow; } }
        .card.play-match-animation { animation: matchAnimation 0.7s ease-in-out; }

        #play-again-btn { margin-top: 15px; padding: 10px 20px; font-size: 1em; font-weight: bold; color: var(--accent-color); background-color: var(--player1-color); border: none; border-radius: 8px; cursor: pointer; display: none; }
        #play-again-btn:hover { background-color: #438a9a; }
        #reset-button { margin-top: 10px; padding: 10px 20px; font-size: 1em; font-weight: bold; color: var(--accent-color); background-color: var(--text-color); border: none; border-radius: 8px; cursor: pointer; }
         #reset-button:hover { background-color: #c93048; }
        #game-id-display { font-size: 0.8em; color: var(--accent-color); margin-top: 10px; opacity: 0.7; }
    </style>
</head>
<body>
    <h1>Jogo da Mem√≥ria Online</h1>
    <div class="game-info"> <div id="player1-info" class="player-score">Jogador 1: 0</div> <div id="player2-info" class="player-score">Jogador 2: 0</div> </div>
    <div id="turn-info">Conectando...</div>
    <div class="game-board" id="game-board"></div>
    <button id="play-again-btn">Jogar Novamente</button>
    <button id="reset-button">Voltar ao Lobby</button>
    <div id="game-id-display"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
        // *** SUA CONFIGURA√á√ÉO REAL DO FIREBASE ***
        // Verifique se esta √© a configura√ß√£o do projeto JOGO DA MEM√ìRIA
        const firebaseConfig = {
    apiKey: "AIzaSyCLAsfQdpaEzk_5IFV39F0m_IyaFsGbAbc",
    authDomain: "jogo-da-memoria-lilica.firebaseapp.com",
    databaseURL: "https://jogo-da-memoria-lilica-default-rtdb.firebaseio.com",
    projectId: "jogo-da-memoria-lilica",
    storageBucket: "jogo-da-memoria-lilica.firebasestorage.app",
    messagingSenderId: "683788488529",
    appId: "1:683788488529:web:727316a3e182257a2d8d70"
        };
        // *******************************************
        let database;
        try { firebase.initializeApp(firebaseConfig); database = firebase.database(); console.log("Firebase inicializado (Game)."); }
        catch (e) { console.error("ERRO FIREBASE:", e); alert("Erro Firebase."); throw new Error("Falha Firebase"); }

        document.addEventListener('DOMContentLoaded', () => {
            const emojis = [ 'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶' ];
            const gameBoard = document.getElementById('game-board');
            const player1InfoEl = document.getElementById('player1-info');
            const player2InfoEl = document.getElementById('player2-info');
            const turnInfoEl = document.getElementById('turn-info');
            const resetButton = document.getElementById('reset-button');
            const playAgainBtn = document.getElementById('play-again-btn');
            const gameIdDisplay = document.getElementById('game-id-display');
            let gameStateRef, gameId, playerId, lockBoard = false, myPlayerUUID;
            let playerNames = { 1: "P1", 2: "P2" };
            let currentBoardState = {};

            // --- FUN√á√ÉO DE INICIALIZA√á√ÉO (Lendo chaves gen√©ricas) ---
            function initGame() {
                 console.log("Iniciando initGame (Mem√≥ria)...");
                 const urlParams = new URLSearchParams(window.location.search);
                 gameId = urlParams.get('game');
                 // *** L√™ as chaves gen√©ricas salvas pelo Lobby ***
                 myPlayerUUID = sessionStorage.getItem('jogoUUID');
                 const myPlayerName = sessionStorage.getItem('jogoPlayerName') || `Jogador?`;
                 // *** Fim da Leitura ***

                 if (!gameId) {
                     console.error("initGame ERRO: ID da sala (gameId) n√£o encontrado.");
                     alert("ID da sala n√£o encontrado. Voltando ao Lobby."); window.location.href = 'index.html'; return;
                 }
                 if (!myPlayerUUID) {
                     console.error("initGame ERRO: ID do jogador (myPlayerUUID) n√£o encontrado.");
                     alert("ID do jogador n√£o encontrado. Voltando ao Lobby."); window.location.href = 'index.html'; return;
                 }

                 console.log(`Conectando sala ${gameId} com UUID ${myPlayerUUID}`);
                 gameStateRef = database.ref('games/' + gameId); // <<<< CAMINHO PARA JOGO DA MEM√ìRIA
                 gameStateRef.transaction(currentState => {
                    if (currentState === null) return null;
                    // Verifica o tipo de jogo para evitar conflitos
                    if (currentState.gameType !== 'memory') { console.error("initGame TX abort: Tipo incorreto!"); return; }
                    if (currentState.player1_uuid === myPlayerUUID) playerId = 1;
                    else if (currentState.player2_uuid === myPlayerUUID) playerId = 2;
                    else if (!currentState.player2_uuid) { playerId = 2; currentState.player2 = true; currentState.player2_uuid = myPlayerUUID; currentState.player2_name = myPlayerName;}
                    else return; // Sala cheia
                    return currentState;
                 }, (error, committed, snapshot) => {
                    if (error || !committed) {
                        let alertMsg = snapshot?.val()?.gameType !== 'memory' ? "Tipo incorreto!" : (snapshot?.val()?.player2_uuid && snapshot.val().player2_uuid !== myPlayerUUID ? "Sala cheia!" : "Sala n√£o encontrada!");
                        alert(alertMsg + " Voltando."); window.location.href = 'index.html';
                    }
                    else { console.log("Conectado (Mem√≥ria) como Jogador:", playerId); setupGameListeners(); }
                 });
             }

            // --- Fun√ß√£o: "Ouvir" as mudan√ßas ---
            function setupGameListeners() {
                gameIdDisplay.textContent = `ID da Sala: ${gameId}`;
                if (gameStateRef) gameStateRef.off();
                gameStateRef.on('value', (snapshot) => {
                    const state = snapshot.val();
                    if (!state) { if (document.visibilityState === 'visible') { /* alert("Jogo encerrado."); window.location.href = 'index.html'; */} return; }
                    playerNames[1] = state.player1_name || "P1"; playerNames[2] = state.player2_name || "P2";
                    state.flippedCards = state.flippedCards || []; state.scores = state.scores || { 1: 0, 2: 0 }; state.victories = state.victories || { 1: 0, 2: 0 }; state.board = state.board || {};
                    const oldBoardState = currentBoardState; currentBoardState = state.board;
                    updateScoreboard(state.scores, state.victories, state.currentPlayer); updateTurnInfo(state.currentPlayer, state.winner, state.player2); renderBoard(currentBoardState, oldBoardState, state.winner);
                    if (state.flippedCards.length === 2 && playerId === state.currentPlayer && !lockBoard) { lockBoard = true; setTimeout(() => checkForMatch(state), 900); }
                    else if (state.flippedCards.length < 2) { lockBoard = false; }
                }, (error) => { console.error("Erro listener:", error); alert("Erro conex√£o."); });
            }

            // --- Fun√ß√£o: Renderizar o Tabuleiro ---
            function renderBoard(newBoardState, oldBoardState, winner) {
                 gameBoard.innerHTML = '';
                 // Garante que itera sobre as chaves num√©ricas corretas (0 a 35)
                 const sortedKeys = Object.keys(newBoardState).map(Number).sort((a, b) => a - b);
                 // Cria placeholders se o board n√£o estiver completo (pode acontecer brevemente)
                 const completeBoardData = {};
                 for(let i=0; i<36; i++) completeBoardData[i] = newBoardState[i] || {id: i, emoji:'?', isFlipped: false, isMatched: false}; // Placeholder

                 Object.values(completeBoardData).forEach(cardData => { // Usa o objeto completo
                     const oldCardData = oldBoardState ? oldBoardState[cardData.id] : null;
                     const cardEl = createCardElement(cardData);
                     if (cardData.isMatched && (!oldCardData || !oldCardData.isMatched)) { cardEl.classList.add('play-match-animation'); setTimeout(() => cardEl.classList.remove('play-match-animation'), 700); }
                     gameBoard.appendChild(cardEl);
                 });
                 playAgainBtn.style.display = winner !== null ? 'block' : 'none';
            }

            // --- Fun√ß√£o: Criar o Elemento HTML da Carta ---
            function createCardElement(cardData) {
                const card = document.createElement('div'); card.classList.add('card'); card.dataset.id = cardData.id;
                card.classList.toggle('flipped', cardData.isFlipped); card.classList.toggle('matched', cardData.isMatched);
                card.innerHTML = `<div class="card-face card-front">${cardData.emoji}</div><div class="card-face card-back"></div>`;
                // S√≥ adiciona listener se n√£o for par E n√£o for placeholder
                if (!cardData.isMatched && cardData.emoji !== '?') { card.addEventListener('click', () => onCardClick(cardData)); }
                else { card.style.cursor = 'default'; }
                return card;
             }

            // --- Fun√ß√£o: L√≥gica do Clique ---
            function onCardClick(cardData) {
                if (lockBoard) return;
                gameStateRef.transaction(currentState => {
                     if (!currentState || !currentState.board) return; const currentFlippedCards = currentState.flippedCards || [];
                     if (currentState.currentPlayer !== playerId || currentState.player2 === null || currentFlippedCards.length >= 2 || !currentState.board[cardData.id] || currentState.board[cardData.id].isFlipped || currentState.board[cardData.id].isMatched) { return; } // Verifica se a carta existe no estado
                     currentState.board[cardData.id].isFlipped = true; if (!currentFlippedCards.includes(cardData.id)) { currentState.flippedCards = [...currentFlippedCards, cardData.id]; }
                     return currentState;
                 });
             }

            // --- Fun√ß√£o: Verificar se √© um Par ---
            function checkForMatch(state) {
                 gameStateRef.transaction(currentState => {
                    if (!currentState || !currentState.flippedCards || currentState.flippedCards.length !== 2 || !currentState.board ) return currentState;
                    const [id1, id2] = currentState.flippedCards; if (!currentState.board[id1] || !currentState.board[id2]) return currentState;
                    const card1 = currentState.board[id1]; const card2 = currentState.board[id2]; const isMatch = card1.emoji === card2.emoji;
                    if (isMatch) { currentState.scores[currentState.currentPlayer]++; currentState.matchedPairs++; currentState.board[id1].isMatched = true; currentState.board[id2].isMatched = true; }
                    else { currentState.currentPlayer = currentState.currentPlayer === 1 ? 2 : 1; currentState.board[id1].isFlipped = false; currentState.board[id2].isFlipped = false; }
                    currentState.flippedCards = [];
                    if (currentState.matchedPairs === emojis.length) { const p1s = currentState.scores[1]; const p2s = currentState.scores[2]; currentState.winner = p1s > p2s ? 1 : (p2s > p1s ? 2 : 0); if (currentState.winner !== 0) { currentState.victories = currentState.victories || { 1: 0, 2: 0 }; currentState.victories[currentState.winner]++; } }
                    return currentState;
                 });
            }

            // --- Fun√ß√£o: Atualizar Placar ---
            function updateScoreboard(scores, victories, currentPlayer) {
                player1InfoEl.innerHTML = `${playerNames[1]} <span class="victories">(V:${victories?.[1] ?? 0})</span> ${scores?.[1] ?? 0} pts`; // Usa optional chaining
                player2InfoEl.innerHTML = `${playerNames[2]} <span class="victories">(V:${victories?.[2] ?? 0})</span> ${scores?.[2] ?? 0} pts`; // Usa optional chaining
                player1InfoEl.classList.toggle('active', currentPlayer === 1); player2InfoEl.classList.toggle('active', currentPlayer === 2);
            }

            // --- Fun√ß√£o: Atualizar Info de Turno e Fim de Jogo ---
            function updateTurnInfo(currentPlayer, winner, player2_connected) {
                if (winner !== null) { let wn = winner === 1 ? playerNames[1] : (winner === 2 ? playerNames[2] : null); let msg = wn ? `${wn} Venceu!` : 'Empate!'; turnInfoEl.textContent = `Fim da Rodada! ${msg}`; playAgainBtn.style.display = 'block'; }
                else { if(!player2_connected) { turnInfoEl.textContent = "Aguardando Jogador 2..."; return; } const cpn = playerNames[currentPlayer]; if (playerId === currentPlayer) { turnInfoEl.textContent = `√â a sua vez, ${cpn}!`; } else { turnInfoEl.textContent = `Vez de ${cpn}`; } playAgainBtn.style.display = 'none'; }
            }

             // --- Fun√ß√£o: Resetar Tabuleiro ---
            function resetBoardForNewRound() {
                 console.log("Resetando tabuleiro...");
                 gameStateRef.transaction(currentState => {
                      if (!currentState || currentState.winner === null) return currentState;
                      const cardPairs = [...emojis, ...emojis].sort(() => 0.5 - Math.random()); currentState.board = {}; cardPairs.forEach((e, i) => { currentState.board[i] = { id: i, emoji: e, isFlipped: false, isMatched: false }; });
                      currentState.scores = { 1: 0, 2: 0 }; currentState.flippedCards = []; currentState.matchedPairs = 0;
                      const lastWinner = currentState.winner; currentState.winner = null; currentState.winnerInfo = null;
                      currentState.currentPlayer = (lastWinner === 1 || lastWinner === 0) ? 2 : 1; // Alterna quem come√ßa
                      return currentState;
                 });
            }

            // --- Event Listeners ---
            if(resetButton){resetButton.addEventListener('click',()=>{if(confirm('Voltar ao Lobby? Jogo ser√° encerrado se for Jogador 1.')){ if(gameStateRef)gameStateRef.off(); if(playerId===1&&gameStateRef){gameStateRef.remove().finally(()=>window.location.href='index.html')} else {window.location.href='index.html'}}})} else {console.error("ERRO: Bot√£o Reset n√£o encontrado!")}
            if(playAgainBtn){ playAgainBtn.addEventListener('click', resetBoardForNewRound); } else { console.error("ERRO: Bot√£o Jogar Novamente n√£o encontrado!")}

            // --- Inicia o Jogo ---
            initGame();

            // --- REGISTRO DO SERVICE WORKER ---
            if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(reg=>console.log('SW reg:', reg.scope)).catch(err=>console.log('SW error:', err)); }); }

        });
    </script>
</body>
</html>

