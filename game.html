<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Memória (Online)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png" type="image/png">
    <meta name="theme-color" content="#16213e">
    
    <style>
        :root {
            --bg-color: #1a1a2e; --card-color: #16213e; --card-flipped-color: #0f3460;
            --text-color: #e94560; --accent-color: #ffffff; --player1-color: #53a8b6; --player2-color: #e94560;
        }
        body {
            font-family: 'Arial', sans-serif; background-color: var(--bg-color); color: var(--accent-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0;
        }
        h1 { color: var(--text-color); margin-bottom: 10px; }
        .game-info { display: flex; justify-content: space-between; width: 320px; margin-bottom: 20px; font-size: 1.2em; }
        .player-score { padding: 10px 20px; border-radius: 8px; font-weight: bold; transition: all 0.3s ease; }
        #player1-score { background-color: var(--player1-color); }
        #player2-score { background-color: var(--player2-color); }
        .player-score.active { box-shadow: 0 0 15px var(--accent-color); transform: scale(1.1); }
        #turn-info { width: 100%; text-align: center; font-size: 1.5em; margin-bottom: 20px; font-weight: bold; }
        .game-board { display: grid; grid-template-columns: repeat(4, 70px); grid-template-rows: repeat(4, 70px); gap: 10px; perspective: 1000px; }
        .card {
            width: 70px; height: 70px; position: relative; transform-style: preserve-3d;
            transition: transform 0.6s; cursor: pointer;
        }
        .card.flipped, .card.matched { transform: rotateY(180deg); cursor: default; }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 40px;
        }
        .card-front { background-color: var(--card-flipped-color); transform: rotateY(180deg); }
        .card-back { background-color: var(--card-color); border: 2px solid var(--text-color); }
        #reset-button {
            margin-top: 20px; padding: 12px 25px; font-size: 1em; font-weight: bold;
            color: var(--accent-color); background-color: var(--text-color); border: none; border-radius: 8px; cursor: pointer;
        }
        #game-id-display { font-size: 0.9em; color: var(--accent-color); margin-top: 10px; opacity: 0.7; }
    </style>
</head>
<body>

    <h1>Jogo da Memória Online</h1>
    
    <div class="game-info">
        <div id="player1-score" class="player-score">Jogador 1: 0</div>
        <div id="player2-score" class="player-score">Jogador 2: 0</div>
    </div>
    
    <div id="turn-info">Conectando...</div>
    
    <div class="game-board" id="game-board">
        </div>

    <button id="reset-button">Voltar ao Lobby</button>
    <div id="game-id-display"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Sua configuração do Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyCLAsfQdpaEzk_5IFV39F0m_IyaFsGbAbc",
          authDomain: "jogo-da-memoria-lilica.firebaseapp.com",
          databaseURL: "https://jogo-da-memoria-lilica-default-rtdb.firebaseio.com",
          projectId: "jogo-da-memoria-lilica",
          storageBucket: "jogo-da-memoria-lilica.firebasestorage.app",
          messagingSenderId: "683788488529",
          appId: "1:683788488529:web:727316a3e182257a2d8d70"
        };

        // Inicializar o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', () => {
            const emojis = ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼'];
            const gameBoard = document.getElementById('game-board');
            const player1ScoreEl = document.getElementById('player1-score');
            const player2ScoreEl = document.getElementById('player2-score');
            const turnInfoEl = document.getElementById('turn-info');
            const resetButton = document.getElementById('reset-button');
            const gameIdDisplay = document.getElementById('game-id-display');

            let gameStateRef; 
            let gameId;       
            let playerId;     // Será 1 ou 2
            let lockBoard = false;
            let myPlayerUUID;

            // --- FUNÇÃO DE INICIALIZAÇÃO (LÓGICA CORRIGIDA COM TRANSAÇÃO) ---
            function initGame() {
                const urlParams = new URLSearchParams(window.location.search);
                gameId = urlParams.get('game');
                
                myPlayerUUID = sessionStorage.getItem('jogoMemoriaUUID');
                if (!myPlayerUUID) {
                    alert("Erro de sessão. Voltando ao Lobby."); window.location.href = 'index.html'; return;
                }
                if (!gameId) {
                    alert("Nenhum ID de sala encontrado. Voltando ao Lobby."); window.location.href = 'index.html'; return;
                }

                // Conecta-se à sala
                gameStateRef = database.ref('games/' + gameId);
                
                // Tenta entrar na sala usando uma transação para garantir atomicidade
                gameStateRef.transaction(currentState => {
                    if (currentState === null) {
                        return null; // Aborta a transação - Sala não existe
                    }

                    if (currentState.player1_uuid === myPlayerUUID) {
                        playerId = 1;
                        console.log("Jogador 1 (re)conectou.");
                        return currentState; 
                    } else if (currentState.player2_uuid === myPlayerUUID) {
                        playerId = 2;
                        console.log("Jogador 2 (re)conectou.");
                        return currentState; 
                    // *** INÍCIO DA CORREÇÃO ***
                    // Verifica se a vaga P2 está VAZIA (!currentState.player2_uuid checa null E undefined)
                    } else if (!currentState.player2_uuid) { 
                    // *** FIM DA CORREÇÃO ***
                        // É o Jogador 2 entrando pela primeira vez
                        playerId = 2;
                        console.log("Jogador 2 entrando e ocupando a vaga.");
                        currentState.player2 = true;
                        currentState.player2_uuid = myPlayerUUID;
                        return currentState; // Retorna o estado modificado para ser salvo
                    } else {
                        // Sala está cheia com outros jogadores
                        console.log("Tentativa de entrar em sala cheia.");
                        return; // Aborta a transação, indicando conflito
                    }
                }, (error, committed, snapshot) => {
                    if (error) {
                        console.error("Erro na transação:", error);
                        alert("Erro ao tentar conectar à sala. Voltando ao Lobby.");
                        window.location.href = 'index.html';
                    } else if (!committed) {
                        // A transação foi abortada
                        if (snapshot && snapshot.val() === null) { // Verifica se foi porque a sala não existia
                            alert("Sala não encontrada! Voltando ao Lobby.");
                        } else {
                            alert("Esta sala já está cheia!");
                        }
                        window.location.href = 'index.html';
                    } else {
                        // Transação bem-sucedida! O jogador está na sala.
                        console.log("Conectado com sucesso como Jogador:", playerId);
                        setupGameListeners(); // Inicia o "ouvinte" do jogo
                    }
                });
            }
            
            // --- Função: "Ouvir" as mudanças do Jogo no Firebase ---
            function setupGameListeners() {
                gameIdDisplay.textContent = `ID da Sala: ${gameId}`;
                
                gameStateRef.on('value', (snapshot) => {
                    const state = snapshot.val();
                    if (!state) {
                        if (document.visibilityState === 'visible') { 
                           alert("O jogo foi encerrado.");
                           window.location.href = 'index.html';
                        }
                        return;
                    } 

                    state.flippedCards = state.flippedCards || [];
                    state.scores = state.scores || { 1: 0, 2: 0 };
                    state.board = state.board || {};

                    updateScoreboard(state.scores, state.currentPlayer);
                    updateTurnInfo(state.currentPlayer, state.winner, state.player2);
                    renderBoard(state.board);
                    
                    // A checagem de par só deve ser feita pelo jogador da vez
                    if (state.flippedCards.length === 2 && playerId === state.currentPlayer) {
                        lockBoard = true; 
                        // Pequeno delay para evitar processar antes da animação de virar terminar visualmente
                        setTimeout(() => checkForMatch(state), 800); 
                    } else {
                        lockBoard = false;
                    }
                });
            }

            // --- Função: Renderizar o Tabuleiro ---
            function renderBoard(boardState) {
                gameBoard.innerHTML = '';
                Object.values(boardState).forEach(cardData => {
                    const cardEl = createCardElement(cardData);
                    gameBoard.appendChild(cardEl);
                });
            }
            
            // --- Função: Criar o Elemento HTML da Carta ---
            function createCardElement(cardData) {
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.id = cardData.id; 
                
                // Aplica classes SEMPRE baseado no estado do Firebase
                card.classList.toggle('flipped', cardData.isFlipped);
                card.classList.toggle('matched', cardData.isMatched);

                card.innerHTML = `
                    <div class="card-face card-front">${cardData.emoji}</div>
                    <div class="card-face card-back"></div>
                `;
                
                // Adiciona listener APENAS se a carta não for par e puder ser clicada
                if (!cardData.isMatched) {
                    card.addEventListener('click', () => onCardClick(cardData));
                } else {
                    card.style.cursor = 'default'; // Garante que não pareça clicável
                }
                return card;
            }

            // --- Função: Lógica do Clique (ENVIA A JOGADA) ---
            function onCardClick(cardData) {
                if (lockBoard) return;
                
                // Usar transação aqui também pode evitar race conditions
                gameStateRef.transaction(currentState => {
                     if (!currentState) return currentState; // Jogo já foi deletado

                     const currentFlippedCards = currentState.flippedCards || [];

                     // Validações MAIS ESTRITAS
                     if (currentState.currentPlayer !== playerId || 
                         currentState.player2 === null || 
                         currentFlippedCards.length >= 2 || // Mudado para >= 2
                         currentState.board[cardData.id].isFlipped || 
                         currentState.board[cardData.id].isMatched) {
                         return; // Aborta a transação sem modificar nada
                     }

                     // Modifica o estado DENTRO da transação
                     currentState.board[cardData.id].isFlipped = true;
                     // Garante que não adicione o mesmo ID duas vezes se clicar muito rápido
                     if (!currentFlippedCards.includes(cardData.id)) {
                         currentState.flippedCards = [...currentFlippedCards, cardData.id];
                     }
                     
                     return currentState; // Retorna o estado modificado
                 });
            }

            // --- Função: Verificar se é um Par (ATUALIZA O JOGO) ---
            function checkForMatch(state) {
                 gameStateRef.transaction(currentState => {
                    if (!currentState) return currentState; 
                    // Garante que ainda estamos no estado esperado (2 cartas viradas)
                    if (!currentState.flippedCards || currentState.flippedCards.length !== 2) return currentState; 

                    const [id1, id2] = currentState.flippedCards;
                    if (!currentState.board[id1] || !currentState.board[id2]) return currentState;

                    const card1 = currentState.board[id1];
                    const card2 = currentState.board[id2];
                    const isMatch = card1.emoji === card2.emoji;

                    if (isMatch) {
                        currentState.scores[currentState.currentPlayer]++;
                        currentState.matchedPairs++;
                        currentState.board[id1].isMatched = true;
                        currentState.board[id2].isMatched = true;
                        // Não precisa virar isFlipped para false se for match
                    } else {
                        currentState.currentPlayer = currentState.currentPlayer === 1 ? 2 : 1;
                        currentState.board[id1].isFlipped = false;
                        currentState.board[id2].isFlipped = false;
                    }
                    
                    currentState.flippedCards = []; // Reseta sempre

                    if (currentState.matchedPairs === emojis.length) {
                         const p1Score = currentState.scores[1];
                         const p2Score = currentState.scores[2];
                         currentState.winner = p1Score > p2Score ? 1 : (p2Score > p1Score ? 2 : 0);
                    }
                    return currentState;
                 });
            }
            
            // --- Função: Atualizar Placar e Turno na Tela ---
            function updateScoreboard(scores, currentPlayer) {
                player1ScoreEl.textContent = `Jogador 1: ${scores[1]}`;
                player2ScoreEl.textContent = `Jogador 2: ${scores[2]}`;
                
                player1ScoreEl.classList.toggle('active', currentPlayer === 1);
                player2ScoreEl.classList.toggle('active', currentPlayer === 2);
            }
            
            // --- Função: Atualizar Info de Turno e Fim de Jogo ---
            function updateTurnInfo(currentPlayer, winner, player2_connected) {
                if (winner !== null) {
                    let winnerMessage = '';
                    if (winner === 1) winnerMessage = 'Jogador 1 Venceu!';
                    else if (winner === 2) winnerMessage = 'Jogador 2 Venceu!';
                    else winnerMessage = 'Empate!';
                    turnInfoEl.textContent = `Fim de Jogo! ${winnerMessage}`;
                } else {
                    if(!player2_connected) {
                         turnInfoEl.textContent = "Aguardando Jogador 2...";
                         return;
                    }
                    
                    if (playerId === currentPlayer) {
                        turnInfoEl.textContent = "É a sua vez!";
                    } else {
                        turnInfoEl.textContent = `Vez do Jogador ${currentPlayer}`;
                    }
                }
            }

            // --- Event Listeners ---
            resetButton.addEventListener('click', () => {
                if (confirm('Tem certeza que deseja sair? O jogo atual será encerrado se você for o Jogador 1.')) {
                    // Remove o ouvinte para evitar tentar ler dados que serão deletados
                    if (gameStateRef) gameStateRef.off(); 
                    
                    if (playerId === 1 && gameStateRef) { 
                        gameStateRef.remove()
                            .then(() => window.location.href = 'index.html')
                            .catch(err => {
                                console.error("Erro ao remover jogo:", err);
                                window.location.href = 'index.html'; // Tenta ir para o lobby mesmo assim
                            });
                    } else {
                        window.location.href = 'index.html'; 
                    }
                }
            });

            // --- Inicia o Jogo ---
            initGame();
        });
    </script>
</body>
</html>
