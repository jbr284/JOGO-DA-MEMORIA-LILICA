<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Velha (Online)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png" type="image/png">
    <meta name="theme-color" content="#16213e">

    <style>
        /* CSS (sem alterações) */
        :root{--bg-color:#1a1a2e;--board-bg-color:#16213e;--cell-bg-color:#0f3460;--text-color:#e94560;--accent-color:#fff;--player1-color:#53a8b6;--player2-color:#e94560;--win-line-color:#f5f542}body{font-family:Arial,sans-serif;background-color:var(--bg-color);color:var(--accent-color);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0}h1{color:var(--text-color);margin-bottom:10px}.game-info{display:flex;justify-content:space-between;width:300px;margin-bottom:20px;font-size:1.1em}.player-score{padding:8px 15px;border-radius:8px;font-weight:700;transition:all .3s ease;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:45%}#player1-info{background-color:var(--player1-color)}#player2-info{background-color:var(--player2-color)}.player-score.active{box-shadow:0 0 15px var(--accent-color);transform:scale(1.05)}#turn-info{width:100%;text-align:center;font-size:1.5em;margin-bottom:20px;font-weight:700;min-height:1.5em}.game-board{display:grid;grid-template-columns:repeat(3,100px);grid-template-rows:repeat(3,100px);gap:5px;background-color:var(--board-bg-color);padding:10px;border-radius:10px;position:relative}.cell{background-color:var(--cell-bg-color);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:60px;font-weight:700;cursor:pointer;transition:background-color .3s}.cell:not(.X):not(.O):hover{background-color:#1f4a81}.cell.X{color:var(--player1-color);cursor:default}.cell.O{color:var(--player2-color);cursor:default}.win-line{position:absolute;background-color:var(--win-line-color);border-radius:5px;box-shadow:0 0 10px var(--win-line-color)}#reset-button{margin-top:25px;padding:12px 25px;font-size:1em;font-weight:700;color:var(--accent-color);background-color:var(--text-color);border:none;border-radius:8px;cursor:pointer}#game-id-display{font-size:.9em;color:var(--accent-color);margin-top:15px;opacity:.7}
    </style>
</head>
<body>

    <h1>Jogo da Velha Online</h1>

    <div class="game-info">
        <div id="player1-info" class="player-score">X (P1): 0</div>
        <div id="player2-info" class="player-score">O (P2): 0</div>
    </div>

    <div id="turn-info">Conectando...</div>

    <div class="game-board" id="game-board">
        </div>

    <button id="reset-button">Voltar ao Lobby</button>
    <div id="game-id-display"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Sua configuração do Firebase
        const firebaseConfig = { /* ... (sua config aqui) ... */ };

        // Inicializar o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', () => {
            const gameBoard = document.getElementById('game-board');
            const player1InfoEl = document.getElementById('player1-info');
            const player2InfoEl = document.getElementById('player2-info');
            const turnInfoEl = document.getElementById('turn-info');
            const resetButton = document.getElementById('reset-button');
            const gameIdDisplay = document.getElementById('game-id-display');

            let gameStateRef;
            let gameId;
            let playerId;
            let myPlayerUUID;
            let playerNames = { 1: "Jogador 1", 2: "Jogador 2" };

            // --- FUNÇÃO DE INICIALIZAÇÃO ---
            function initGame() { /* ... (código igual à versão anterior) ... */ }

            // --- Função: "Ouvir" as mudanças do Jogo no Firebase ---
            function setupGameListeners() { /* ... (código igual à versão anterior) ... */ }

            // --- Função: Renderizar o Tabuleiro ---
            function renderBoard(boardState, winnerInfo) { /* ... (código igual à versão anterior) ... */ }

            // --- Função: Lógica do Clique na Célula (ENVIA A JOGADA - CORRIGIDO) ---
            function onCellClick(index) {
                console.log(`onCellClick: Célula ${index} clicada.`);

                gameStateRef.transaction(currentState => {
                     if (!currentState) {
                         console.log("onCellClick abortado: Estado nulo");
                         return currentState;
                     }
                     // *** INÍCIO DA CORREÇÃO ***
                     // Garante que o board existe antes de tentar acessá-lo
                     if (!currentState.board) {
                          console.error("onCellClick abortado: currentState.board é undefined!");
                          return; // Aborta a transação se o board não estiver pronto
                     }
                     // *** FIM DA CORREÇÃO ***

                     console.log("onCellClick - Estado atual:", currentState);
                     console.log("onCellClick - Meu playerId:", playerId);

                     // Validações
                     if (currentState.winner) {
                         console.log("onCellClick abortado: Jogo já acabou (winner:", currentState.winner, ")");
                         return; // Jogo já acabou
                     }
                     if (currentState.currentPlayer !== playerId) {
                         console.log(`onCellClick abortado: Não é minha vez (currentPlayer: ${currentState.currentPlayer}, meuId: ${playerId})`);
                         return; // Não é minha vez
                     }
                     if (currentState.board[index] !== null) {
                         console.log(`onCellClick abortado: Célula ${index} já ocupada com ${currentState.board[index]}`);
                         return; // Célula já ocupada
                     }

                     console.log(`onCellClick: Jogada válida na célula ${index} pelo Jogador ${playerId}`);

                     // Modifica o estado
                     currentState.board[index] = playerId === 1 ? 'X' : 'O';

                     const winnerCheck = checkForWinner(currentState.board);
                     if (winnerCheck) {
                         currentState.winner = winnerCheck.winner;
                         currentState.winnerInfo = winnerCheck;
                         if (winnerCheck.winner === 'X') currentState.scores[1]++;
                         else if (winnerCheck.winner === 'O') currentState.scores[2]++;
                         else currentState.scores.ties++;
                     } else {
                         currentState.currentPlayer = currentState.currentPlayer === 1 ? 2 : 1;
                     }

                     return currentState;
                 });
            }

            // --- Função: Verificar Vitória ou Empate ---
            function checkForWinner(board) { /* ... (sem alterações) ... */ }

            // --- Função: Desenha a linha de vitória ---
             function drawWinLine(winnerInfo) { /* ... (sem alterações) ... */ }

            // --- Função: Atualizar Placar ---
            function updateScoreboard(scores) { /* ... (sem alterações) ... */ }

            // --- Função: Atualizar Info de Turno e Fim de Jogo ---
            function updateTurnInfo(currentPlayer, winner, player2_uuid) { /* ... (sem alterações) ... */ }

            // --- Event Listeners ---
            resetButton.addEventListener('click', () => { /* ... (sem alterações) ... */ });

            // --- Inicia o Jogo ---
            initGame();
        });
    </script>
</body>
</html>
