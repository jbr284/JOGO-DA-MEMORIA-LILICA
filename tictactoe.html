<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Velha (Online)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png" type="image/png">
    <meta name="theme-color" content="#16213e">

    <style>
        /* CSS (sem alterações) */
        :root{--bg-color:#1a1a2e;--board-bg-color:#16213e;--cell-bg-color:#0f3460;--text-color:#e94560;--accent-color:#fff;--player1-color:#53a8b6;--player2-color:#e94560;--win-line-color:#f5f542}body{font-family:Arial,sans-serif;background-color:var(--bg-color);color:var(--accent-color);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0}h1{color:var(--text-color);margin-bottom:10px}.game-info{display:flex;justify-content:space-between;width:300px;margin-bottom:20px;font-size:1.1em}.player-score{padding:8px 15px;border-radius:8px;font-weight:700;transition:all .3s ease;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:45%}#player1-info{background-color:var(--player1-color)}#player2-info{background-color:var(--player2-color)}.player-score.active{box-shadow:0 0 15px var(--accent-color);transform:scale(1.05)}#turn-info{width:100%;text-align:center;font-size:1.5em;margin-bottom:20px;font-weight:700;min-height:1.5em}.game-board{display:grid;grid-template-columns:repeat(3,100px);grid-template-rows:repeat(3,100px);gap:5px;background-color:var(--board-bg-color);padding:10px;border-radius:10px;position:relative}.cell{background-color:var(--cell-bg-color);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:60px;font-weight:700;cursor:pointer;transition:background-color .3s}.cell:not(.X):not(.O):hover{background-color:#1f4a81}.cell.X{color:var(--player1-color);cursor:default}.cell.O{color:var(--player2-color);cursor:default}.win-line{position:absolute;background-color:var(--win-line-color);border-radius:5px;box-shadow:0 0 10px var(--win-line-color)}#reset-button{margin-top:25px;padding:12px 25px;font-size:1em;font-weight:700;color:var(--accent-color);background-color:var(--text-color);border:none;border-radius:8px;cursor:pointer}#game-id-display{font-size:.9em;color:var(--accent-color);margin-top:15px;opacity:.7}
    </style>
</head>
<body>

    <h1>Jogo da Velha Online</h1>

    <div class="game-info">
        <div id="player1-info" class="player-score">X (P1): 0</div>
        <div id="player2-info" class="player-score">O (P2): 0</div>
    </div>

    <div id="turn-info">Conectando...</div>

    <div class="game-board" id="game-board">
        </div>

    <button id="reset-button">Voltar ao Lobby</button>
    <div id="game-id-display"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Sua configuração do Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyCLAsfQdpaEzk_5IFV39F0m_IyaFsGbAbc",
          authDomain: "jogo-da-memoria-lilica.firebaseapp.com",
          databaseURL: "https://jogo-da-memoria-lilica-default-rtdb.firebaseio.com",
          projectId: "jogo-da-memoria-lilica",
          storageBucket: "jogo-da-memoria-lilica.firebasestorage.app",
          messagingSenderId: "683788488529",
          appId: "1:683788488529:web:727316a3e182257a2d8d70"
        };

        // Inicializar o Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            console.log("Firebase inicializado com sucesso."); // LOG INICIALIZAÇÃO
        } catch (e) {
            console.error("ERRO FATAL AO INICIALIZAR FIREBASE:", e);
            alert("Erro crítico ao inicializar. Verifique a configuração do Firebase.");
        }


        document.addEventListener('DOMContentLoaded', () => {
            const gameBoard = document.getElementById('game-board');
            const player1InfoEl = document.getElementById('player1-info');
            const player2InfoEl = document.getElementById('player2-info');
            const turnInfoEl = document.getElementById('turn-info');
            const resetButton = document.getElementById('reset-button');
            const gameIdDisplay = document.getElementById('game-id-display');

            let gameStateRef;
            let gameId;
            let playerId;
            let myPlayerUUID;
            let playerNames = { 1: "Jogador 1", 2: "Jogador 2" };

            // --- FUNÇÃO DE INICIALIZAÇÃO ---
            function initGame() {
                console.log("Iniciando initGame...");
                const urlParams = new URLSearchParams(window.location.search);
                gameId = urlParams.get('game');

                myPlayerUUID = sessionStorage.getItem('jogoMemoriaUUID');
                if (!myPlayerUUID) { console.error("Erro fatal: UUID não encontrado."); alert("Erro de sessão..."); window.location.href = 'index.html'; return; }
                if (!gameId) { console.error("Erro fatal: gameId não encontrado na URL."); alert("Nenhum ID de sala..."); window.location.href = 'index.html'; return; }

                console.log(`initGame: Tentando conectar à sala ${gameId} com UUID ${myPlayerUUID}`);
                // Adiciona tratamento de erro para database indefinido (se inicialização falhou)
                if (typeof database === 'undefined' || !database) {
                     console.error("initGame: Instância do Database não está definida!");
                     alert("Erro na conexão com o banco de dados.");
                     return;
                }
                gameStateRef = database.ref('games/' + gameId);

                gameStateRef.transaction(currentState => {
                    console.log("initGame - Dentro da transação. Estado atual recebido:", currentState);
                    if (currentState === null) { console.log("Transação abortada: Sala não existe (currentState é null)."); return null; }
                    if (currentState.gameType !== 'tictactoe') { console.log("Transação abortada: Tipo de jogo incorreto."); return; } // undefined aborta

                    if (currentState.player1_uuid === myPlayerUUID) playerId = 1;
                    else if (currentState.player2_uuid === myPlayerUUID) playerId = 2;
                    else if (!currentState.player2_uuid) {
                        playerId = 2;
                        currentState.player2_uuid = myPlayerUUID;
                        currentState.player2_name = sessionStorage.getItem('jogoMemoriaPlayerName') || `Jogador ${playerId}`;
                    } else { console.log("Transação abortada: Sala cheia."); return; } // undefined aborta

                    console.log(`initGame - Transação: Estado a ser salvo com playerId ${playerId}:`, currentState);
                    return currentState;
                }, (error, committed, snapshot) => {
                    console.log(`initGame - Resultado da transação: error=${error}, committed=${committed}`); // LOG RESULTADO TRANSAÇÃO
                    if (error) {
                        console.error("Erro na transação initGame:", error);
                        alert("Erro ao tentar conectar à sala. Voltando ao Lobby."); window.location.href = 'index.html';
                    } else if (!committed) {
                        console.warn("Transação initGame não commitada. Estado final lido:", snapshot?.val());
                         alert(snapshot?.val()?.gameType !== 'tictactoe' ? "Tipo de jogo incorreto!" : (snapshot?.val()?.player2_uuid && snapshot.val().player2_uuid !== myPlayerUUID ? "Sala cheia!" : "Sala não encontrada!"));
                        window.location.href = 'index.html';
                    } else {
                        // ** Só chama setupGameListeners se a transação foi bem sucedida **
                        console.log("initGame: Transação OK. Conectado como Jogador:", playerId);
                        setupGameListeners();
                    }
                });
            }

            // --- Função: "Ouvir" as mudanças do Jogo no Firebase ---
            function setupGameListeners() {
                console.log(`setupGameListeners: Configurando ouvinte para sala ${gameId}`);
                gameIdDisplay.textContent = `ID da Sala: ${gameId}`;

                // Usa 'off()' para garantir que não haja listeners duplicados se algo der errado
                if (gameStateRef) gameStateRef.off();

                gameStateRef.on('value', (snapshot) => {
                    const state = snapshot.val();
                    console.log("setupGameListeners - 'on value'. Estado recebido:", state);

                    if (!state) {
                        console.warn("setupGameListeners: Estado nulo recebido (jogo encerrado?).");
                        if (document.visibilityState === 'visible') {
                           // alert("O jogo foi encerrado.");
                           // window.location.href = 'index.html'; // Comentar por enquanto para depurar
                        }
                        return;
                    }

                    playerNames[1] = state.player1_name || "Jogador 1";
                    playerNames[2] = state.player2_name || "Jogador 2";
                    state.board = state.board ? (Array.isArray(state.board) ? state.board : Object.values(state.board)) : Array(9).fill(null);
                    state.scores = state.scores || { 1: 0, 2: 0, ties: 0 };

                    console.log("setupGameListeners: Estado normalizado pronto para UI:", state);

                    updateScoreboard(state.scores);
                    updateTurnInfo(state.currentPlayer, state.winner, state.player2_uuid);
                    renderBoard(state.board, state.winnerInfo);
                }, (error) => {
                     console.error("Erro CRÍTICO no listener do Firebase 'on value':", error);
                     alert("Erro de conexão com o jogo em tempo real. Tente recarregar.");
                     turnInfoEl.textContent = "Erro de Conexão!";
                });
            }

            // --- Função: Renderizar o Tabuleiro ---
            function renderBoard(boardState, winnerInfo) {
                 console.log("renderBoard chamado com board:", boardState, "e winnerInfo:", winnerInfo);
                 gameBoard.innerHTML = '';
                 const oldWinLine = gameBoard.querySelector('.win-line');
                 if (oldWinLine) oldWinLine.remove();

                 if (!Array.isArray(boardState)) {
                     console.error("renderBoard Erro: boardState não é um array!", boardState);
                     turnInfoEl.textContent = "Erro ao carregar tabuleiro!";
                     boardState = Array(9).fill(null); // Tenta renderizar vazio
                 }

                 boardState.forEach((cellValue, index) => {
                     const cell = document.createElement('div');
                     cell.classList.add('cell');
                     cell.dataset.index = index;
                     if (cellValue) {
                         cell.textContent = cellValue;
                         cell.classList.add(cellValue);
                         cell.style.cursor = 'default';
                     } else if (winnerInfo === undefined || winnerInfo === null) {
                         // Adiciona listener APENAS se a célula está vazia E o jogo não acabou
                         cell.addEventListener('click', () => onCellClick(index));
                     } else {
                          cell.style.cursor = 'default'; // Jogo acabou, não clicável
                     }
                     gameBoard.appendChild(cell);
                 });
                 if (winnerInfo) { drawWinLine(winnerInfo); }
            }


            // --- Função: Lógica do Clique na Célula ---
            function onCellClick(index) { /* ... (código igual à versão anterior, já tem logs) ... */ }
            // --- Função: Verificar Vitória ou Empate ---
            function checkForWinner(board) { /* ... (código igual) ... */ }
            // --- Função: Desenha a linha de vitória ---
            function drawWinLine(winnerInfo) { /* ... (código igual) ... */ }
            // --- Função: Atualizar Placar ---
            function updateScoreboard(scores) { /* ... (código igual) ... */ }
            // --- Função: Atualizar Info de Turno e Fim de Jogo ---
            function updateTurnInfo(currentPlayer, winner, player2_uuid) { /* ... (código igual) ... */ }
            // --- Event Listeners ---
            resetButton.addEventListener('click', () => { /* ... (código igual) ... */ });

            // --- Inicia o Jogo ---
            initGame();
        });
    </script>
</body>
</html>
