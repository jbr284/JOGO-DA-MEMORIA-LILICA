<!DOCTYPE html>
<html lang="pt-br">
<head>
    <style>
        /* ... (CSS sem alterações) ... */
    </style>
</head>
<body>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Sua configuração do Firebase
        const firebaseConfig = {  apiKey: "AIzaSyCLAsfQdpaEzk_5IFV39F0m_IyaFsGbAbc",
  authDomain: "jogo-da-memoria-lilica.firebaseapp.com",
  databaseURL: "https://jogo-da-memoria-lilica-default-rtdb.firebaseio.com",
  projectId: "jogo-da-memoria-lilica",
  storageBucket: "jogo-da-memoria-lilica.firebasestorage.app",
  messagingSenderId: "683788488529",
  appId: "1:683788488529:web:727316a3e182257a2d8d70"};
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', () => {
            // ... (variáveis sem alterações) ...
            let gameStateRef;
            let gameId;
            let playerId;
            let myPlayerUUID;
            let playerNames = { 1: "Jogador 1", 2: "Jogador 2" };

            // --- FUNÇÃO DE INICIALIZAÇÃO ---
            function initGame() {
                console.log("Iniciando initGame..."); // LOG 1
                const urlParams = new URLSearchParams(window.location.search);
                gameId = urlParams.get('game');
                
                myPlayerUUID = sessionStorage.getItem('jogoMemoriaUUID');
                if (!myPlayerUUID) { console.error("Erro fatal: UUID não encontrado."); alert("Erro de sessão..."); window.location.href = 'index.html'; return; }
                if (!gameId) { console.error("Erro fatal: gameId não encontrado na URL."); alert("Nenhum ID de sala..."); window.location.href = 'index.html'; return; }

                console.log(`initGame: Conectando à sala ${gameId} com UUID ${myPlayerUUID}`); // LOG 2
                gameStateRef = database.ref('games/' + gameId);
                
                gameStateRef.transaction(currentState => {
                    console.log("initGame - Dentro da transação. Estado atual:", currentState); // LOG 3
                    if (currentState === null) { console.log("Transação abortada: Sala não existe."); return null; } 
                    if (currentState.gameType !== 'tictactoe') { console.log("Transação abortada: Tipo de jogo incorreto."); return; } 

                    if (currentState.player1_uuid === myPlayerUUID) playerId = 1;
                    else if (currentState.player2_uuid === myPlayerUUID) playerId = 2;
                    else if (!currentState.player2_uuid) { 
                        playerId = 2;
                        currentState.player2_uuid = myPlayerUUID;
                        currentState.player2_name = sessionStorage.getItem('jogoMemoriaPlayerName') || `Jogador ${playerId}`; 
                    } else { console.log("Transação abortada: Sala cheia."); return; } 
                    
                    console.log(`initGame - Transação: Definido playerId como ${playerId}`); // LOG 4
                    return currentState; 
                }, (error, committed, snapshot) => {
                    if (error) {
                        console.error("Erro na transação initGame:", error);
                        alert("Erro ao tentar conectar à sala. Voltando ao Lobby."); window.location.href = 'index.html';
                    } else if (!committed) {
                        console.warn("Transação initGame não commitada (sala cheia/inexistente?). Estado final:", snapshot?.val()); // LOG 5
                         alert(snapshot?.val()?.gameType !== 'tictactoe' ? "Tipo de jogo incorreto!" : (snapshot?.val()?.player2_uuid && snapshot.val().player2_uuid !== myPlayerUUID ? "Sala cheia!" : "Sala não encontrada!"));
                        window.location.href = 'index.html';
                    } else {
                        console.log("initGame: Conectado com sucesso como Jogador:", playerId); // LOG 6
                        setupGameListeners(); 
                    }
                });
            }
            
            // --- Função: "Ouvir" as mudanças do Jogo no Firebase ---
            function setupGameListeners() {
                console.log(`setupGameListeners: Iniciando ouvinte para sala ${gameId}`); // LOG 7
                gameIdDisplay.textContent = `ID da Sala: ${gameId}`;
                
                gameStateRef.on('value', (snapshot) => {
                    const state = snapshot.val();
                    console.log("setupGameListeners - 'on value' chamado. Estado recebido:", state); // LOG 8
                    
                    if (!state) { 
                        console.warn("setupGameListeners: Estado nulo recebido (jogo encerrado?).");
                        if (document.visibilityState === 'visible') { 
                           alert("O jogo foi encerrado.");
                           window.location.href = 'index.html';
                        }
                        return;
                    } 

                    playerNames[1] = state.player1_name || "Jogador 1";
                    playerNames[2] = state.player2_name || "Jogador 2";
                    // Garante que board seja um array, mesmo que venha como objeto ou nulo
                    state.board = state.board ? (Array.isArray(state.board) ? state.board : Object.values(state.board)) : Array(9).fill(null); 
                    state.scores = state.scores || { 1: 0, 2: 0, ties: 0 };
                    
                    console.log("setupGameListeners: Estado normalizado:", state); // LOG 9
                    
                    updateScoreboard(state.scores);
                    updateTurnInfo(state.currentPlayer, state.winner, state.player2_uuid);
                    renderBoard(state.board, state.winnerInfo); 
                }, (error) => { // Adiciona tratamento de erro para o listener 'on'
                     console.error("Erro no listener do Firebase 'on value':", error);
                     alert("Erro de conexão com o jogo. Tente recarregar.");
                });
            }

            // --- Função: Renderizar o Tabuleiro ---
            function renderBoard(boardState, winnerInfo) {
                 console.log("renderBoard chamado com board:", boardState); // LOG 10
                 gameBoard.innerHTML = ''; 
                 const oldWinLine = gameBoard.querySelector('.win-line');
                 if (oldWinLine) oldWinLine.remove();

                 // Adiciona verificação se boardState é realmente um array
                 if (!Array.isArray(boardState)) {
                     console.error("renderBoard Erro: boardState não é um array!", boardState);
                     turnInfoEl.textContent = "Erro ao carregar tabuleiro!";
                     return;
                 }

                 boardState.forEach((cellValue, index) => {
                     const cell = document.createElement('div');
                     cell.classList.add('cell');
                     cell.dataset.index = index; 
                     if (cellValue) {
                         cell.textContent = cellValue; 
                         cell.classList.add(cellValue);
                         cell.style.cursor = 'default'; 
                     } else if (winnerInfo === undefined || winnerInfo === null) { 
                         cell.addEventListener('click', () => onCellClick(index));
                     } else {
                          cell.style.cursor = 'default'; 
                     }
                     gameBoard.appendChild(cell);
                 });
                 if (winnerInfo) { drawWinLine(winnerInfo); }
            }
            
            // --- Função: Lógica do Clique na Célula ---
            function onCellClick(index) { /* ... (código igual, já tem logs) ... */ }
            // --- Função: Verificar Vitória ou Empate ---
            function checkForWinner(board) { /* ... (código igual) ... */ }
            // --- Função: Desenha a linha de vitória ---
            function drawWinLine(winnerInfo) { /* ... (código igual) ... */ }
            // --- Função: Atualizar Placar ---
            function updateScoreboard(scores) { /* ... (código igual) ... */ }
            // --- Função: Atualizar Info de Turno e Fim de Jogo ---
            function updateTurnInfo(currentPlayer, winner, player2_uuid) { /* ... (código igual) ... */ }
            // --- Event Listeners ---
            resetButton.addEventListener('click', () => { /* ... (código igual) ... */ });

            // --- Inicia o Jogo ---
            initGame();
        });
    </script>
</body>
</html>

